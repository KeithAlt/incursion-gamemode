local a,b=CasinoKit.L,CasinoKit.ML;local c=CasinoKit.class("HoldEmCl","CardGameCl")c.enableOverviewUI=true;function c:getGameFriendlyName()return"Hold 'em"end;function c:getGameFriendlySubtext()return b(string.format("#holdem_ante %d - #holdem_smallbet %d",self:getAnte(),self:getSmallBet()))end;function c:getAnte()local d=self:getTableEntity()return IsValid(d)and d:GetAnte()or-1 end;function c:getSmallBet()local d=self:getTableEntity()return IsValid(d)and d:GetSmallBet()or-1 end;function c:getTimeoutDelay()local d=self:getTableEntity()return IsValid(d)and d:GetTimeoutDelay()or-1 end;function c:handleGameMessage(e,f)if e=="ccard"then self.communityCards=self.communityCards or{}local g=#self.communityCards;local h=self:createCardObject(f:getCard(),Vector(5,-3.5+(g-1)*5,0))table.insert(self.communityCards,h)if self:isLocalPlayerSitting()then local i=CasinoKit.classes.CardSet(CasinoKit.fn.map(self.communityCards,function(j)return j.card end))MsgN("[CasinoKit] Community cards: "..tostring(i))end elseif e=="nturn"then self.turn=f:get()local k=f:get()self.turnStartTime=CurTime()-LocalPlayer():Ping()*0.001/2;self.turnEndTime=self.turnStartTime+k;self.betAmount=f:getInt()self.askingForAmount=f:getInt()if self:getTableEntity():GetMySeatIndex()==self.turn then surface.PlaySound("HL1/fvox/bell.wav")end elseif e=="chpot"then self.pot=f:getInt()self.sidepots=f:getArray(function(l,m)return f:getInt()end)local n=table.Random{"chipsHandle1.ogg","chipsHandle3.ogg","chipsHandle4.ogg","chipsHandle5.ogg","chipsHandle6.ogg"}self:playTableSound("file:sound/casinokit/"..n)elseif e=="fipot"then local function o(p)local q={name=p,handName=f:getString(),amount=f:getInt(),winnerSeats=f:getArray(function()return f:get()end)}local r={}for l,s in pairs(q.winnerSeats)do local t=self:getSeatPly(self:getTableEntity(),s)table.insert(r,IsValid(t)and t:Nick()or"-")end;q.winnersString=table.concat(r,",")return q end;self.finalPotData=f:getArray(function(l,u)return o(f:getString())end)else c.super.handleGameMessage(self,e,f)end end;function c:onStateChanged(v)c.super.onStateChanged(self,v)if v=="showdown"then timer.Simple(0.5,function()if self:isLocalPlayerSitting()then local w=CasinoKit.classes.PokerHandEvaluator()local i=CasinoKit.classes.CardSet(CasinoKit.fn.map(self.communityCards or{},function(j)return j.card end))MsgN("[CasinoKit] Hold 'em game summary:")MsgN("[CasinoKit] Community cards: "..tostring(i))for g,x in pairs(self:getPlayers())do local y=x:getCards()or{}local z=true;for l,h in pairs(y)do if h.card then z=false;break end end;local A={}local B="[not revealed]"if not z then A=CasinoKit.classes.CardSet(CasinoKit.fn.map(y,function(j)return j.card end))local C=w:evaluate(i+A)B=C and C.name or"nothing"end;MsgN("[CasinoKit] Player #"..tostring(g).." cards: "..tostring(A).."; hand value: "..B)end end end)end;if v=="gameover"then self.communityCards=nil;self.sidepots={}self.pot=0;self.finalPotData={}self.hasShownCards=false end end;function c:getCardHorizOffset(D)return(D-1.5)*0.20 end;function c:getCardVertOffset(D)return 22 end;function c:drawTable(E,F)c.super.drawTable(self,E,F)for g,G in pairs(self.communityCards or{})do self:drawCard(E,F,G)end;local H=E:LocalToWorld(F+Vector(13,0,0))CasinoKit.drawChipStack(self.pot or 0,H,E:GetAngles(),true)for u,I in pairs(self.sidepots or{})do local H=E:LocalToWorld(F+Vector(13,u*7,0))CasinoKit.drawChipStack(I or 0,H,E:GetAngles(),true)end end;function c:sendAction(E,J)local K=CasinoKit.classes.OutBuffer()K:putString(J)self:sendInput(K)end;function c:stateMessage()local L=self.state;if not L then if#self:getPlayers()<2 then return a"waitingforplayers"end;return"-unknown state-"end;if L=="idle"then return a"waitingforplayers"end;local M=string.format("holdem_%s",L)return a(M)end;function c:getActivityPosition(E,F)local N=c.super.getActivityPosition(self,E,F)if N then return N end;local O=self:getTurnGmodPly(E)if IsValid(O)then return O:EyePos()end end;function c:getSeatPly(E,s)for l,P in pairs(E:GetCachedSeatindexPlyTuples())do if P[1]==s then return P[2]end end end;function c:getTurnGmodPly(E)local Q=self.turn;return self:getSeatPly(E,Q)end;local R=Color(248,148,6)function c:helpMessage(E)if self.state=="preFlopBets"or self.state=="flopBets"or self.state=="turnBets"or self.state=="riverBets"then local Q=self.turn;if self:getMySeatIndex()==Q then return a("holdem_yourturn"),R else local S=self:getTurnGmodPly(E)return a("holdem_plyturn",{player=IsValid(S)and S:Nick()or""})end end end;function c:onGameplayMessageReceived(T)c.super.onGameplayMessageReceived(self,T)if self.holdemGameplayMessage then self.holdemGameplayMessage.replaced=CurTime()self.holdemOldGameplayMessages=self.holdemOldGameplayMessages or{}table.insert(self.holdemOldGameplayMessages,self.holdemGameplayMessage)end;self.holdemGameplayMessage={msg=T}end;function c:drawUI(E,x)c.super.drawUI(self,E,x)local U=self.holdemGameplayMessages or{}local V=self.holdemGameplayMessage;if V then x:Text(V.msg or"","!Roboto@11",0,-40)end;if self.holdemOldGameplayMessages then for l,C in pairs(self.holdemOldGameplayMessages)do local W=(CurTime()-C.replaced)/2;if W>1 then table.RemoveByValue(self.holdemOldGameplayMessages,C)else local X=W*W;x:Text(C.msg or"","!Roboto@11",0,-50+X*-50,Color(255,255,255,(1-X)*255))end end end;local Y,Z=self:helpMessage(E)x:Rect(-85,-25,170,Y and 50 or 25,nil,Color(255,255,255))x:Text(self:stateMessage(),"!Roboto@18",0,-22)if Y then x:Line(-80,-2,80,-2)x:Text(Y,"!Roboto@15",0,5,Z)end;local _=self:getTurnGmodPly(E)if(self.state=="preFlopBets"or self.state=="flopBets"or self.state=="turnBets"or self.state=="riverBets")and _==LocalPlayer()then if self.turnStartTime and self.turnEndTime then local a0=CurTime()-self.turnStartTime;local a1=a0/(self.turnEndTime-self.turnStartTime)x:Rect(-85,32,170,5,nil,Color(255,255,255))x:Rect(-85,32,170*(1-a1),5,Color(255,255,255),nil)end;local a2=self.askingForAmount or 0;local a3=self.betAmount or 0;local a4=LocalPlayer():CKit_GetChips()>=a2;if a4 and x:Button(a2==0 and a"holdem_check"or a("holdem_call",{amount=a2}),"!Roboto@16",-85,45,80,30)then self:sendAction(E,"call")end;if a4 then self:drawBetButton(E,x,a2)end;if not a4 and x:Button(a"holdem_allin","!Roboto@16",-85,80,80,30)then self:sendAction(E,"allin")end;if x:Button(a"holdem_fold","!Roboto@16",5,80,80,30)then self:sendAction(E,"fold")end end;if self.state=="showdown"and not self.hasShownCards and table.Count(self:getPlayers())==1 then local a5=self:getPlayerInSeat(self:getMySeatIndex(),true)if a5 and x:Button(a"holdem_showcards","!Roboto@16",-85,45,170,25)then self:sendAction(E,"showcards")self.hasShownCards=true end end;if self.finalPotData then for u,a6 in pairs(self.finalPotData)do local a7=a("holdem_ply_win",{pot_name=a6.name,amount=a6.amount,player=a6.winnersString,hand_name=a6.handName})x:Text(a7,"!Roboto@18",90,-37+u*15,nil,TEXT_ALIGN_LEFT)end end end;function c:drawBetButton(E,x,a2)local a3=self.betAmount or 0;if x:Button(a2==0 and a("holdem_bet",{amount=a3})or a("holdem_raise",{amount=a2+a3,raise=a3}),"!Roboto@16",5,45,80,30)then self:sendAction(E,"raise")end end;function c:addGameSettings(a8)a8:integer("Ante","ante",self:getAnte(),5,10000)a8:integer("Small bet","smallbet",self:getSmallBet(),5,10000)a8:integer("Timeout delay (seconds)","timeoutdelay",self:getTimeoutDelay(),5,180)c.super.addGameSettings(self,a8)end;function c:getHelpHTML()return[[
	<h2>Hold 'em rules</h2>
	<p>
		]]..a("holdem_rules_p",{link_start='<a href="javascript:openRules()">',link_end='</a>'})..[[
	</p>
	<script>
		function openRules() {
			gmod.OpenUrl(']]..a"holdem_rules_url"..[[')
		}
	</script>
	]]end